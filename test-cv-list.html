<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test CV List</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 { color: #423772; }
        button {
            background: #423772;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #6D5BA6; }
        .result {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f9f9f9;
        }
        .error { color: red; }
        .success { color: green; }
        .cv-item {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            background: white;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Liste des CVs</h1>
        
        <div>
            <p><strong>Token actuel:</strong> <span id="tokenDisplay">Aucun</span></p>
            <p><strong>User ID:</strong> <span id="userIdDisplay">N/A</span></p>
        </div>

        <div>
            <button onclick="testGetCVs()">üìã GET /api/cv/</button>
            <button onclick="testUploadCV()">üì§ Test Upload CV</button>
            <button onclick="checkToken()">üîç V√©rifier Token</button>
            <button onclick="clearResults()">üóëÔ∏è Effacer</button>
        </div>

        <div id="result" class="result"></div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        
        function getToken() {
            return localStorage.getItem('auth_token');
        }

        function displayToken() {
            const token = getToken();
            if (token) {
                document.getElementById('tokenDisplay').textContent = token.substring(0, 50) + '...';
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    document.getElementById('userIdDisplay').textContent = payload.userId || payload.id || 'N/A';
                    console.log('Token payload:', payload);
                } catch(e) {
                    console.error('Erreur decode token:', e);
                }
            } else {
                document.getElementById('tokenDisplay').textContent = 'Aucun token trouv√©';
            }
        }

        function showResult(message, isError = false) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<div class="${isError ? 'error' : 'success'}">${message}</div>`;
        }

        function showJSON(data) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }

        async function testGetCVs() {
            const token = getToken();
            if (!token) {
                showResult('‚ùå Aucun token trouv√©. Connectez-vous d\'abord sur http://localhost:3001/login', true);
                return;
            }

            showResult('‚è≥ Chargement des CVs...');

            try {
                const response = await fetch(`${API_URL}/api/cv/`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                const data = await response.json();
                
                if (!response.ok) {
                    showResult(`‚ùå Erreur ${response.status}: ${data.message || 'Unknown error'}`, true);
                    console.error('Response:', data);
                    return;
                }

                console.log('CVs r√©cup√©r√©s:', data);

                if (data.status === 'success' && data.data && data.data.cvs) {
                    const cvs = data.data.cvs;
                    if (cvs.length === 0) {
                        showResult('‚úÖ Aucun CV upload√© pour le moment');
                    } else {
                        let html = `<h3>‚úÖ ${cvs.length} CV(s) trouv√©(s):</h3>`;
                        cvs.forEach((cv, index) => {
                            html += `
                                <div class="cv-item">
                                    <strong>CV #${index + 1}: ${cv.originalName}</strong><br>
                                    <small>ID: ${cv._id}</small><br>
                                    <small>Fichier: ${cv.filename}</small><br>
                                    <small>Taille: ${(cv.fileSize / 1024).toFixed(2)} KB</small><br>
                                    <small>Date: ${new Date(cv.uploadDate).toLocaleString('fr-FR')}</small><br>
                                    <small>Statut: ${cv.isAnalyzed ? '‚úÖ Analys√©' : '‚è≥ En attente'}</small>
                                </div>
                            `;
                        });
                        document.getElementById('result').innerHTML = html;
                    }
                } else {
                    showJSON(data);
                }
            } catch (error) {
                showResult(`‚ùå Erreur r√©seau: ${error.message}`, true);
                console.error('Error:', error);
            }
        }

        async function testUploadCV() {
            showResult('‚ÑπÔ∏è Fonction √† impl√©menter - Utilisez la page CV pour uploader');
        }

        function checkToken() {
            const token = getToken();
            if (!token) {
                showResult('‚ùå Aucun token. Connectez-vous sur http://localhost:3001/login', true);
                return;
            }

            try {
                const payload = JSON.parse(atob(token.split('.')[1]));
                let html = '<h3>‚úÖ Token d√©cod√©:</h3>';
                html += `<pre>${JSON.stringify(payload, null, 2)}</pre>`;
                html += `<p><strong>Expiration:</strong> ${new Date(payload.exp * 1000).toLocaleString('fr-FR')}</p>`;
                
                const now = Date.now() / 1000;
                if (payload.exp < now) {
                    html += '<p class="error">‚ö†Ô∏è Token expir√©!</p>';
                } else {
                    html += '<p class="success">‚úÖ Token valide</p>';
                }
                
                document.getElementById('result').innerHTML = html;
            } catch(e) {
                showResult(`‚ùå Erreur d√©codage: ${e.message}`, true);
            }
        }

        function clearResults() {
            document.getElementById('result').innerHTML = '';
        }

        // Afficher le token au chargement
        displayToken();
    </script>
</body>
</html>
